<html>
<head>
<title>glsl-simulator: manual input</title>
<link rel="stylesheet" href="lib/codemirror.css">
<script src="../browser/glsl-simulator-0.1.0.js"></script>
<script src="lib/codemirror.js"></script>
<script src="lib/jsDump.js"></script>
<script src="lib/mode/glsl.js"></script>

<style type="text/css">
#container {
    display: flex;
    display: -webkit-flex;
    flex-direction: row;
    -webkit-flex-direction: row;
    flex-wrap: nowrap;
    -webkit-flex-wrap: nowrap;
    justify: space-around;
    -webkit-justify: space-around;

    position: absolute;
    top: 0; right: 0; bottom: 0; left: 0;
    overflow: none;
}

#container > div {
    width: 50%;
    display: flex;
    display: -webkit-flex;
    flex-direction: column;
    -webkit-flex-direction: column;
    flex-wrap: nowrap;
    -webkit-flex-wrap: nowrap;
}

#shader-header {
    height: 30px;
    font: 14px Helvetica, Arial, sans-serif;
    font-weight: bold;
    line-height: 28px;
    text-transform: uppercase;
    padding-left: 20px;
}

#editor-selector {
    position: absolute;
    right: 20px;
    top: 5px;
    z-index: 1000;
}

#variable-editor {
    border: solid 3px #99c;
    height: 200px;
    overflow-y: scroll;
}

#shader-editor {
    border: solid 3px #c99;
    height: 75%;
    position: relative;
}

#shader-editor-stub {
    height: 100%;
}

.results-viewer {
    overflow: scroll;
    border: solid 3px #9c9;
    position: relative;
    height: 50%;
}

.results-viewer .output-options {
    position: fixed;
    right: 20px;
    display: inline;
}

.results-viewer .output {
    white-space: pre;
    font-family: Menlo, monospace;
    font-size: 12px;
}

.input-row {
    display: -webkit-flex;
    display: flex;
    -webkit-align-items: center;
    align-items: center;

    border-bottom: 1px solid #e0e0e0;
}

.input-row.out {
    background-color: #f5f5f5;
}

span.variable-usage {
    text-transform: uppercase;
    text-align: center;
    font-family: Arial;
    font-size: 10px;
    font-weight: bold;
    color: #666;
    background-color: #fff;

    border-radius: 4px;
    border: solid 2px #ccc;

    margin: 0px 5px;
    padding: 2px;
    width: 25px;
}

span.variable-qualifier {
    text-transform: uppercase;
    text-align: center;
    font-family: Arial;
    font-size: 10px;
    font-weight: bold;
    color: #666;
    background-color: #fff;

    border-radius: 4px;
    border: solid 2px #ccc;

    padding: 2px;
    margin: 0px 5px;
    width: 60px;
}

.variable-qualifier.uniform {
    color: #1b7837;
}

.variable-qualifier.varying {
    color: #b2182b;
}

.variable-qualifier.attribute {
    color: #3288bd;
}

span.input-label {
    width: 20%;
    text-align: right;
    line-height: 25px;
    padding-right: 10px;
    padding-top: 5px;
    font-size: 16px;
    font-family: Myriad Pro, Helvetica, sans-serif;
}

span.input-label.builtin {
    font-style: italic;
}

span.type-label {
    font-family: Arial;
    font-size: 10px;
    border-radius: 4px;
    color: #fff;
    font-weight: bold;
    padding: 2px;
}

span.type-label.float {
    background-color: rgb(166, 171, 183);
    border: solid 2px rgb(86, 100, 138);
    text-shadow: 1px 1px 2px rgb(86, 100, 138);
}

span.type-label.vec2,
span.type-label.vec3,
span.type-label.vec4 {
    background-color: rgb(149, 192, 148);
    border: solid 2px rgb(100, 137, 97);
    text-shadow: 1px 1px 2px rgb(100, 137, 97);
}

span.type-label.mat2,
span.type-label.mat3,
span.type-label.mat4 {
    background-color: rgb(171, 143, 186);
    border: solid 2px rgb(119, 94, 131);
    text-shadow: 1px 1px 2px rgb(119, 94, 131);
}

table.input-cells {
    font-family: monospace;
    font-size: 16px;
}

table.input-cells input[type="number"] {
    font-size: 12px;
    font-family: Menlo, monospace;
    width: 4em;
}

/* Disable the number spinner arrow things on elements. It's dumb. */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
</style>

</head>
<body>
    <form>
<div id="container">
<div id="left-side">
    <div id="shader-header">
    GLSL Simulator Demo
    </div>
    <div id="variable-editor">
    <div id="variable-list">
    </div>
    </div>
    <div id="shader-editor">
    <select name="editor-selector" id="editor-selector">
    </select>
    <div id="shader-editor-stub">
    </div>
    </div>
</div>
<div id="right-side">
<div class="results-viewer" id="results-top">
<span class="output-options">
    <select id="results-top-shader-selector"></select>
    <select id="results-top-output-selector"></select>
</span>
</div>
<div class="results-viewer" id="results-bottom">
<span class="output-options">
    <select id="results-bottom-shader-selector"></select>
    <select id="results-bottom-output-selector"></select>
</span>
</div>
</div>
</form>
</div>

<script type="x-glsl-vshader" id="sample-vertex-shader">
attribute vec2 position;

void main()
{
    gl_Position = vec4(position, 0.0, 1.0);
}
</script>
<script type="x-glsl-fshader" id="sample-fragment-shader">
// Sample shader from: http://glslsandbox.com/e#21330.5

/* Here's a block
comment for you.
*/

#ifdef GL_ES
precision mediump float;
#endif

uniform float time;
uniform vec2 mouse;
uniform vec2 resolution;
// b/w remix
// tomaes.32x.de 2014.11
void main( void ) {

    vec3 col = vec3(0.1,0.2,0.3);
    vec2 pos = ( gl_FragCoord.xy / resolution.xy );

    float sd = 0.19 - (pos.y*0.004 / pos.x*0.5) - atan( pos.x + pos.y, 40.0 );
    float so = 0.22 + pos.y*0.0003/pos.x*(0.15 + sin(time*0.04+pos.x*3.5));

    float t = mod(time*0.1, 2.0) + 440.0;
    float x = mod(pos.x + t, so);
    float y = mod(pos.y + t, so*2.0);
    float d1 = mod( distance( vec2(x,y), vec2(so*0.45,so*1.05) ) + t*0.5, 0.05) * 3.0 + pos.x * 0.5;
    float d2 = mod( distance( vec2(x,y), vec2(so*0.55,so*0.95) ) + t*0.5, 0.015) * 3.0;

    if ((x-0.03 < sd) && (y-0.03 < sd*2.0))
    if ((x < sd) && (y < sd*2.0))
        col = vec3(0.2, 0.6, mix(d1, d2, 0.8) );
    else
        col = vec3(0.72, 0.25, pos.y * 0.06 + 0.3);


    float l = length(mod(t* 0.1 + col * distance(pos,vec2(pos.y,0.0)) ,0.02)*27.5); 

    if ((pos.y>0.1) && (pos.y < 0.9))
        gl_FragColor = vec4( l,l,l, 1.0 );
    else
        gl_FragColor = vec4( 0.9,0.9,0.9, 1.0);
}
</script>

<script type="text/javascript">

var OutputPane = function(which) {
    this.resultsPane = document.getElementById("results-" + which);
    this.shaderSelector = document.getElementById("results-" + which + "-shader-selector");
    this.outputSelector = document.getElementById("results-" + which + "-output-selector");
    this.outputElement = null;

    var option = null;
    option = document.createElement("option");
    option.text = "Vertex Shader";
    option.value = GLSL.Shader.Type.Vertex;
    this.shaderSelector.add(option, null);

    option = document.createElement("option");
    option.text = "Fragment Shader";
    option.value = GLSL.Shader.Type.Fragment;
    this.shaderSelector.add(option, null);

    option = document.createElement("option");
    option.text = "Shader AST";
    option.value = "ast";
    this.outputSelector.add(option, null);

    option = document.createElement("option");
    option.text = "Pretty Printer";
    option.value = "pretty";
    this.outputSelector.add(option, null);

    this.shaderSelector.addEventListener("change", this.refresh.bind(this));
    this.outputSelector.addEventListener("change", this.refresh.bind(this));
};

OutputPane.prototype = {
    refresh: function()
    {
        if (this.outputElement)
            this.resultsPane.removeChild(this.outputElement);

        var selectedShaderType = this.shaderSelector.options[this.shaderSelector.selectedIndex].value;
        var shader = program.shaderWithType(selectedShaderType);

        var selectedOutputType = this.outputSelector.options[this.outputSelector.selectedIndex].value;
        this.outputElement = document.createElement("span");
        this.outputElement.classList.add("output");

        switch (selectedOutputType) {
        case "ast":
            this.outputElement.appendChild(document.createTextNode(jsDump.parse(shader.ast)));
        break;

        case "pretty":
        default:
            var printer = new GLSL.PrettyPrinter();
            this.outputElement.appendChild(document.createTextNode(printer.formattedText(shader.ast)));
        break;
        }

        this.resultsPane.appendChild(this.outputElement);
    }
}

var cm = CodeMirror(function(elt) {
    var editorNode = document.getElementById("shader-editor-stub");
    editorNode.parentNode.replaceChild(elt, editorNode);
    elt.id = editorNode.id;
}, {
    value: "",
    mode: "glsl",
    lineNumbers: true
});

var editorNode = document.getElementById("shader-editor-stub");
var editorSelector = document.getElementById("editor-selector");

var resultsTop = new OutputPane("top");
var resultsBottom = new OutputPane("bottom");

var program = new GLSL.Program();

// Try to save inputs with same names across multiple edits.
var inputs = {};

/* TODO:
- When codegen result is available, provide inputs / run shader / read outputs
*/
cm.on("changes", function shaderEditorContentChanged() {
    try {
        var shader = new GLSL.Shader(cm.getValue(), editorNode.shaderType);
        program.insertShader(shader);
        populateVariableEditor(shader);
        resultsTop.refresh();
        resultsBottom.refresh();
    } catch (e) {
        resultsTop.outputElement.textContent = "ERROR: " + e.message;
    }
});

window.addEventListener("load", function initEditors() {
    // Initialize shaders with examples.
    try {
    program.insertShader(new GLSL.Shader(document.getElementById("sample-vertex-shader").textContent, GLSL.Shader.Type.Vertex));
    program.insertShader(new GLSL.Shader(document.getElementById("sample-fragment-shader").textContent, GLSL.Shader.Type.Fragment));
    } catch (e) {
        resultsTop.outputElement.textContent = "ERROR: " + e.message;
    }

    [editorSelector].map(function populateShaderOptions(selector) {
        var option = null;
        option = document.createElement("option");
        option.text = "Vertex Shader";
        option.value = GLSL.Shader.Type.Vertex;
        selector.add(option, null);

        option = document.createElement("option");
        option.text = "Fragment Shader";
        option.value = GLSL.Shader.Type.Fragment;
        selector.add(option, null);
    });

    editorSelector.addEventListener("change", editorShaderSelectorChanged);

    // Select the fragment shader by default.
    editorSelector.options[1].selected = true;
    // The above line won't trigger a "change" event, so fake it ourselves.
    editorShaderSelectorChanged({ target: editorSelector });

    function manuallyAdjustEditorHeight() {
        editorNode.style.height = editorNode.parentElement.offsetHeight - 5 + "px";
    }

    window.addEventListener("resize", manuallyAdjustEditorHeight);
    manuallyAdjustEditorHeight();
});

function editorShaderSelectorChanged(event) {
    console.assert(event.target === editorSelector, event.target);
    console.assert(event.target.selectedIndex != -1, event.target);

    var selectedShaderType = editorSelector.options[editorSelector.selectedIndex].value;
    if (editorNode.shaderType === selectedShaderType)
        return;

    var selectedShader = program.shaderWithType(selectedShaderType);
    // Do the swap.
    editorNode.shaderType = selectedShaderType;
    cm.setValue(selectedShader ? selectedShader.sourceText : "");
}

function shaderInputsChanged(shader, inputMap) {
    // TODO
};

function populateVariableEditor(shader) {
    function makeInput(variable) {
        var inputRow = document.createElement("div");
        inputRow.classList.add("input-row", variable.usage);

        var usageLabel = inputRow.appendChild(document.createElement("span"));
        usageLabel.classList.add("variable-usage", variable.usage);
        usageLabel.textContent = variable.usage;

        var qualifierLabel = inputRow.appendChild(document.createElement("span"));
        qualifierLabel.classList.add("variable-qualifier", variable.qualifier);
        qualifierLabel.textContent = variable.qualifier;

        var label = inputRow.appendChild(document.createElement("span"));
        label.classList.add("input-label");
        if (variable.builtin)
            label.classList.add("builtin");
        label.textContent = variable.name;

        var typeLabel = inputRow.appendChild(document.createElement("span"));
        typeLabel.classList.add(variable.type, "type-label");
        typeLabel.textContent = variable.type;

        // TODO: handle sampler2D and samplerCube seperately, by adding a
        // file upload widget and thumbnail preview.

        var form = inputRow.appendChild(document.createElement("table"));
        form.classList.add("input-cells");

        var rowCount = 1;
        var colCount = 1;

        switch (variable.type) {
        case "float": break;
        case "vec2":  colCount = 2; break;
        case "vec3":  colCount = 3; break;
        case "vec4":  colCount = 4; break;
        case "mat2":  colCount = 2; rowCount = 2; break;
        case "mat3":  colCount = 3; rowCount = 3; break;
        case "mat4":  colCount = 4; rowCount = 4; break;
        default: break;
        }

        var elements = [];

        for (var i = 0; i < rowCount; ++i) {
            var row = document.createElement("tr");
            for (var j = 0; j < colCount; ++j) {
                var cell = document.createElement("td");
                if (j == 0)
                    cell.appendChild(document.createTextNode(i == 0 && colCount > 1 ? "[" : "\u00A0"));

                var input = cell.appendChild(document.createElement("input"));
                input.type = "number";
                input.maxLength = 5;
                input.placeholder = "0.0";
                if (variable.usage === "out")
                    input.readOnly = true;
                elements.push(input);
                if (j < colCount - 1)
                    cell.appendChild(document.createTextNode(","));
                else if (colCount > 1 && i == rowCount - 1)
                    cell.appendChild(document.createTextNode("]"))
                row.appendChild(cell);
            }

            form.appendChild(row);
        }

        if (variable.name in inputs) {
            var existingValue = inputs[variable.name];
            for (var i = 0; i < elements.length; ++i)
                elements[i].value = existingValue[i];
        }

        function cellValueDidChange(event) {
            if (elements.indexOf(event.target) == -1)
                return;

            var value = null;
            if (elements.length === 1) {
                value = elements[0].value;
            } else {
                var value = [];
                for (var i = 0; i < elements.length; ++i)
                    value.push(elements[i].value);
            }

            inputs[variable.name] = value;
            shaderInputsChanged(shader, inputs);
        }

        form.addEventListener("input", cellValueDidChange);
        return inputRow;
    }

    var variablesNode = document.getElementById("variable-list");

    while (variablesNode.hasChildNodes())
        variablesNode.removeChild(variablesNode.lastChild);

    var uniforms = shader.uniforms;
    var attributes = shader.attributes;
    var varyings = shader.varyings;

    // TODO: add a divider and section label?
    uniforms.map(function(v) { variablesNode.appendChild(makeInput(v)); });

    if (shader.type === GLSL.Shader.Type.Vertex)
        attributes.map(function(v) { variablesNode.appendChild(makeInput(v)); });

    varyings.map(function(v) { variablesNode.appendChild(makeInput(v)); });
}

</script>

</body>
</html>
